{% extends 'main/base.html' %}

{% load summary %}

{% block title %}{{ object }}{% endblock %}

{% block content %}
<h1 class="govuk-heading-l">{{ object }}</h1>

<dl class="govuk-summary-list">
    {% field_summary object 'type' %}
    {% field_summary object 'job_title' %}
    {% field_summary object 'project_name' %}
    {% field_summary object 'start_date' %}
    {% field_summary object 'profession' %}
    {% field_summary object 'end_date' %}
    {% field_summary object 'is_ir35' %}
    {% field_summary object 'chief' %}
    {% field_summary object 'requestor' %}
    {% field_summary object 'state' %}
</dl>

<h2 class="govuk-heading-m">Supporting forms</h2>

<dl class="govuk-summary-list">
    <!-- Financial information -->
    <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
            Financial information
        </dt>
        <dd class="govuk-summary-list__value">
            {{ object.financial_information|default:'No financial information' }}
        </dd>
        <dd class="govuk-summary-list__actions">
            {% if perms.main.view_financialinformation and object.financial_information %}
                <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'financial-information-detail' object.financial_information.pk %}">View</a>
            {% endif %}
            {% if perms.main.change_financialinformation and object.financial_information and object.can_update %}
                <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'financial-information-update' object.financial_information.pk %}">Update</a>
            {% elif perms.main.add_financialinformation and not object.financial_information %}
                <a class="govuk-button govuk-button mb-0" href="{% url 'financial-information-create' %}?resourcing_request={{ object.pk }}">Create</a>
            {% endif %}
        </dd>
    </div>

    <!-- Job description -->
    <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
            Job description
        </dt>
        <dd class="govuk-summary-list__value">
            {% if object.is_ir35 %}
                {{ object.job_description|default:'No job description' }}
            {% else %}
                Not required
            {% endif %}
        </dd>
        <dd class="govuk-summary-list__actions">
            {% if object.is_ir35 %}
                {% if perms.main.view_jobdescription and object.job_description %}
                    <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'job-description-detail' object.job_description.pk %}">View</a>
                {% endif %}
                {% if perms.main.change_jobdescription and object.job_description and object.can_update %}
                    <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'job-description-update' object.job_description.pk %}">Update</a>
                {% elif perms.main.add_jobdescription and not object.job_description %}
                    <a class="govuk-button govuk-button mb-0" href="{% url 'job-description-create' %}?resourcing_request={{ object.pk }}">Create</a>
                {% endif %}
            {% endif %}
        </dd>
    </div>

    <!-- Statement of work -->
    <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
            Statement of work
        </dt>
        <dd class="govuk-summary-list__value">
            {% if not object.is_ir35 %}
                {{ object.statement_of_work|default:'No statement of work' }}
            {% else %}
                Not required
            {% endif %}
        </dd>
        <dd class="govuk-summary-list__actions">
            {% if not object.is_ir35 %}
                {% if perms.main.view_statementofwork and object.statement_of_work %}
                    <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'statement-of-work-detail' object.statement_of_work.pk %}">View</a>
                {% endif %}
                {% if perms.main.change_statementofwork and object.statement_of_work and object.can_update %}
                    <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'statement-of-work-update' object.statement_of_work.pk %}">Update</a>
                {% elif perms.main.add_statementofwork and not object.statement_of_work %}
                    <a class="govuk-button govuk-button mb-0" href="{% url 'statement-of-work-create' %}?resourcing_request={{ object.pk }}">Create</a>
                {% endif %}
            {% endif %}
        </dd>
    </div>

    <!-- Interim request -->
    <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
            Interim request
        </dt>
        <dd class="govuk-summary-list__value">
            {{ object.interim_request|default:'No interim request' }}
        </dd>
        <dd class="govuk-summary-list__actions">
            {% if perms.main.view_interimrequest and object.interim_request %}
                <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'interim-request-detail' object.interim_request.pk %}">View</a>
            {% endif %}
            {% if perms.main.change_interimrequest and object.interim_request and object.can_update %}
                <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'interim-request-update' object.interim_request.pk %}">Update</a>
            {% elif perms.main.add_interimrequest and not object.interim_request %}
                <a class="govuk-button govuk-button mb-0" href="{% url 'interim-request-create' %}?resourcing_request={{ object.pk }}">Create</a>
            {% endif %}
        </dd>
    </div>

    <!-- CEST rationale -->
    <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
            CEST rationale
        </dt>
        <dd class="govuk-summary-list__value">
            {{ object.cest_rationale|default:'No CEST rationale' }}
        </dd>
        <dd class="govuk-summary-list__actions">
            {% if perms.main.view_cestrationale and object.cest_rationale %}
                <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'cest-rationale-detail' object.cest_rationale.pk %}">View</a>
            {% endif %}
            {% if perms.main.change_cestrationale and object.cest_rationale and object.can_update %}
                <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'cest-rationale-update' object.cest_rationale.pk %}">Update</a>
            {% elif perms.main.add_cestrationale and not object.cest_rationale %}
                <a class="govuk-button govuk-button mb-0" href="{% url 'cest-rationale-create' %}?resourcing_request={{ object.pk }}">Create</a>
            {% endif %}
        </dd>
    </div>

    <!-- CEST document -->
    <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
            CEST document
        </dt>
        <dd class="govuk-summary-list__value">
            {{ object.cest_document|default:'No CEST document' }}
        </dd>
        <dd class="govuk-summary-list__actions">
            {% if perms.main.view_cestdocument and object.cest_document %}
                <a class="govuk-button govuk-button--secondary mb-0" href="{{ object.cest_document.file.url }}">View</a>
            {% endif %}
            {% if perms.main.change_cestdocument and object.cest_document and object.can_update %}
                <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'cest-document-update' object.cest_document.pk %}">Update</a>
            {% elif perms.main.add_cestdocument and not object.cest_document %}
                <a class="govuk-button govuk-button mb-0" href="{% url 'cest-document-create' %}?resourcing_request={{ object.pk }}">Create</a>
            {% endif %}
        </dd>
    </div>

    <!-- SDS status determination -->
    <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
            SDS status determination
        </dt>
        <dd class="govuk-summary-list__value">
            {{ object.sds_status_determination|default:'No SDS status determination' }}
        </dd>
        <dd class="govuk-summary-list__actions">
            {% if perms.main.view_sdsstatusdetermination and object.sds_status_determination %}
                <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'sds-status-determination-detail' object.sds_status_determination.pk %}">View</a>
            {% endif %}
            {% if perms.main.change_sdsstatusdetermination and object.sds_status_determination and object.can_update %}
                <a class="govuk-button govuk-button--secondary mb-0" href="{% url 'sds-status-determination-update' object.sds_status_determination.pk %}">Update</a>
            {% elif perms.main.add_sdsstatusdetermination and not object.sds_status_determination %}
                <a class="govuk-button govuk-button mb-0" href="{% url 'sds-status-determination-create' %}?resourcing_request={{ object.pk }}">Create</a>
            {% endif %}
        </dd>
    </div>
</dl>

<!-- Actions -->
{% if perms.main.change_resourcingrequest %}
    {% if object.can_send_for_approval %}
        <form class="inline" action="{% url 'resourcing-request-send-for-approval' object.pk %}" method="post">
            {% csrf_token %}
            <button class="govuk-button">Send for approval</button>
        </form>
    {% endif %}

    {% if object.can_amend %}
        <form class="inline" action="{% url 'resourcing-request-amend' object.pk %}" method="post">
            {% csrf_token %}
            <button class="govuk-button govuk-button--secondary">Amend</button>
        </form>
    {% endif %}

    {% if object.can_send_for_review %}
        <form class="inline" action="{% url 'resourcing-request-send-for-review' object.pk %}" method="post">
            {% csrf_token %}
            <button class="govuk-button">Send for review</button>
        </form>
    {% endif %}

    {% if object.can_update %}
        <a class="govuk-button govuk-button--secondary" href="{% url 'resourcing-request-update' object.pk %}">Update</a>
    {% endif %}
{% endif %}

{% if perms.main.can_give_busops_approval and object.can_finish_amendments_review %}
    <form class="inline" action="{% url 'resourcing-request-finish-amendments-review' object.pk %}" method="post">
        {% csrf_token %}
        <button class="govuk-button">Finish amendments review</button>
    </form>
{% endif %}

{% if perms.main.delete_resourcingrequest %}
    <form
        class="inline"
        action="{% url 'resourcing-request-delete' object.pk %}"
        method="post"
        data-confirm="Are you sure you want to delete this resourcing request?"
    >
        {% csrf_token %}
        <button class="govuk-button govuk-button--warning">Delete</button>
    </form>
{% endif %}

<!-- Approvals -->
<h1 class="govuk-heading-l">Approvals</h1>

{% if object.is_draft %}
    <p class="govuk-body">Resourcing request is not ready for approval.</p>
{% else %}
    {% include 'main/partials/approvals.html' with form=approval_form resourcing_request=object can_user_approve=can_user_approve %}
{% endif %}

<!-- Comments -->
<h1 class="govuk-heading-l">Comments</h1>

{% if perms.main.view_comment %}
    {% for comment in object.comments.all %}
    <div>
        <span class="govuk-body govuk-!-font-weight-bold">{{ comment.user }}</span><span class="govuk-body-s secondary-text ml-1">{{ comment.timestamp }}</span>
        <p class="govuk-body">
            {{ comment.text }}
        </p>
    </div>
    {% endfor %}
{% endif %}

{% if perms.main.add_comment %}
    <form action="{% url 'resourcing-request-add-comment' object.pk %}" method="post">
        {% csrf_token %}
        {% include 'main/partials/forms/form.html' with form=comment_form %}
        <button class="govuk-button">Add comment</button>
    </form>
{% endif %}

<!-- Event log -->
<details class="govuk-details" data-module="govuk-details">
    <summary class="govuk-details__summary">
        <span class="govuk-details__summary-text">
            Event log
        </span>
    </summary>
    <div class="govuk-details__text">
        {% include 'event_log/event_log.html' with event_log=object.event_log.all %}
    </div>
</details>

<script>
function handleFormConfirmSubmit(event) {
    event.preventDefault();

    form = event.target;

    if (confirm(form.dataset.confirm)) {
        form.submit();
    } else {
        return;
    }
}

document.querySelectorAll("form[data-confirm]").forEach(function (form) {
    form.addEventListener('submit', handleFormConfirmSubmit);
})
</script>
{% endblock %}
